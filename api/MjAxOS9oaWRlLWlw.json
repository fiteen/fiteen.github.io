{"title":"V2Ray + CDN 中转隐藏 IP","date":"2019-12-12T17:43:01.000Z","date_formatted":{"ll":"Dec 13, 2019","L":"12/13/2019","MM-DD":"12-13"},"thumbnail":"2019/hide-ip/hide-ip.png","link":"2019/hide-ip","comments":true,"tags":["CDN","Cloudflare","DNS","V2Ray"],"categories":["科学上网"],"updated":"2022-09-02T06:38:13.694Z","content":"<blockquote>\n<p>⚠️⚠️⚠️ <strong>声明：本文内容仅限技术交流，若有用作商业或其他违规行为，与本人无关。</strong></p>\n</blockquote>\n<span id=\"more\"></span>\n<p>IP 又双叒叕被墙了？</p>\n<p>刚换的 IP 还没捂热又凉了，怎么办？</p>\n<p>下面教你一招，为你的 IP 加上双重保护锁，从此躲开“中奖”，快乐省钱又省心！</p>\n<h2 id=\"原理\">原理<a title=\"#原理\" href=\"#原理\"></a></h2>\n<p>先在 VPS 服务器上用 V2Ray 伪装成一个网站，再用 CDN 中转。这时流量传递的顺序是这样的：</p>\n<p><img src=\"/2019/hide-ip/visitor-firewall-cdn-vps-website.png\" alt=\"CDN 中转\" class=\"φcx\"></p>\n<p>主要实现就是两点：<br>\n一、借助 V2Ray 代理，将我们的流量被伪装成网站流量<br>\n二、利用 CDN 中转 V2Ray 的 WebSocket 流量</p>\n<p>这样，GFW 只知道你与 CDN 之间的联系，不知道 VPS 的实际地址，并且 CDN 会有很多 IP 地址，GFW 也不会随意封这些 IP，毕竟也有很多正规网站在使用，因此可以基本保证 IP 的安全。</p>\n<h2 id=\"准备工作\">准备工作<a title=\"#准备工作\" href=\"#准备工作\"></a></h2>\n<p>于是，只要有了 VPS、域名和 CDN，就能实现这套方案：</p>\n<ul>\n<li>VPS：推荐 <a href=\"https://bandwagonhost.com/\" target=\"_blank\">BandwagonHost</a>、<a href=\"https://www.vultr.com\" target=\"_blank\">Vultr</a>、<a href=\"https://www.hostwinds.com\" target=\"_blank\">Hostwinds</a>、<a href=\"https://manage.hostdare.com/index.php\" target=\"_blank\">HostDare</a>、<a href=\"teach-you-to-build-a-free-Shadowsocks-service\">谷歌免费薅一年</a>。</li>\n<li>域名：通过阿里云/腾讯云/华为云等购买域名，<code>.xyz</code>、<code>.top</code> 都是性价比比较高的选择。如果不想花钱也可以在 <a href=\"http://www.freenom.com/nl/index.html\" target=\"_blank\">freenom</a> 上注册一个免费域名，运气好的话域名免费有效期可以达到 12 个月。</li>\n<li>CDN：推荐使用美国的 Cloudflare，优点是免费、无需备案。</li>\n</ul>\n<h2 id=\"v2ray\">V2Ray<a title=\"#v2ray\" href=\"#v2ray\"></a></h2>\n<h3 id=\"什么是-v2ray\">什么是 V2Ray<a title=\"#什么是-v2ray\" href=\"#什么是-v2ray\"></a></h3>\n<p>V2Ray 是继 Shadowsocks 之后一款非常好用的代理软件，甚至比 Shadowsocks 更优秀，它拥有更多可选择的协议和传输载体，还有强大的路由功能。</p>\n<p>想要知道它的工作机制、本地策略、如何配置等细节可以查看 <a href=\"https://www.v2ray.com\" target=\"_blank\">V2Ray 官网</a>。</p>\n<h3 id=\"搭建-v2ray-服务\">搭建 V2Ray 服务<a title=\"#搭建-v2ray-服务\" href=\"#搭建-v2ray-服务\"></a></h3>\n<p>V2Ray 的配置其实是比较繁琐的，可以借助这个<a href=\"https://github.com/233boy/v2ray/wiki/V2Ray%E4%B8%80%E9%94%AE%E5%AE%89%E8%A3%85%E8%84%9A%E6%9C%AC\" target=\"_blank\">一键安装脚本</a>快速配置。</p>\n<h3 id=\"安装脚本\">安装脚本<a title=\"#安装脚本\" href=\"#安装脚本\"></a></h3>\n<p>通过 SSH 连接到 VPS 主机，以 root 用户输入以下命令来安装或卸载脚本：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bash &lt;(curl -s -L https://git.io/v2ray.sh)</span><br></pre></td></tr></table></figure>\n<h3 id=\"管理-v2ray\">管理 V2Ray<a title=\"#管理-v2ray\" href=\"#管理-v2ray\"></a></h3>\n<p>安装完成后，直接在终端输入 <code>v2ray</code> 就可以进行管理。面板上会出现如下选项：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> 1. 查看 V2Ray 配置</span><br><span class=\"line\"> 2. 修改 V2Ray 配置</span><br><span class=\"line\"> 3. 下载 V2Ray 配置 / 生成配置信息链接 / 生成二维码链接</span><br><span class=\"line\"> 4. 查看 Shadowsocks 配置 / 生成二维码链接</span><br><span class=\"line\"> 5. 修改 Shadowsocks 配置</span><br><span class=\"line\"> 6. 查看 MTProto 配置 / 修改 MTProto 配置</span><br><span class=\"line\"> 7. 查看 Socks5 配置 / 修改 Socks5 配置</span><br><span class=\"line\"> 8. 启动 / 停止 / 重启 / 查看日志</span><br><span class=\"line\"> 9. 更新 V2Ray / 更新 V2Ray 管理脚本</span><br><span class=\"line\">10. 卸载 V2Ray</span><br><span class=\"line\">11. 其他</span><br></pre></td></tr></table></figure>\n<p>输入 <code>2</code> 进入修改 V2Ray 面板，面板上会出现如下选项：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. 修改 V2Ray 端口</span><br><span class=\"line\">2. 修改 V2Ray 传输协议</span><br><span class=\"line\">3. 修改 V2Ray 动态端口 (如果可以)</span><br><span class=\"line\">4. 修改 用户ID ( UUID )</span><br><span class=\"line\">5. 修改 TLS 域名 (如果可以)</span><br><span class=\"line\">6. 修改 分流的路径 (如果可以)</span><br><span class=\"line\">7. 修改 伪装的网址 (如果可以)</span><br><span class=\"line\">8. 关闭 网站伪装 和 路径分流 (如果可以)</span><br><span class=\"line\">9. 开启 / 关闭 广告拦截</span><br></pre></td></tr></table></figure>\n<p>输入 <code>2</code> 修改 V2Ray 传输协议，终端会输出当前的传输协议，如果不是 <code>WebSocket + TLS</code>，继续在终端输入 <code>4</code> 改成这个协议。如图下所示，依次点击回车键、输入正确的域名、将域名解析到指定的 IPv4 地址。</p>\n<p><img src=\"/2019/hide-ip/domain-name-resolution.png\" alt=\"输入域名并解析到指定地址\" class=\"φcx\"></p>\n<p>关于域名解析，以阿里云为例，像这样添加一条 A 记录类型即可。</p>\n<p><img src=\"/2019/hide-ip/aliyun-resolution.png\" alt=\"阿里云域名解析\" class=\"φcx\"></p>\n<p>接下来，你还会被询问是否要<strong>设置分流路径</strong>和<strong>伪装的网址</strong>，如果没有特殊要求，回复默认项即可。</p>\n<p>修改配置完成后，终端会输出新的配置信息，形如：</p>\n<p><img src=\"/2019/hide-ip/v2ray-config.png\" alt=\"V2Ray 配置信息\" class=\"φcx\"></p>\n<p>你也可以通过以下命令进行<strong>快速管理</strong>：</p>\n<ul>\n<li><code>v2ray info</code> 查看 V2Ray 配置信息</li>\n<li><code>v2ray config</code> 修改 V2Ray 配置</li>\n<li><code>v2ray link</code> 生成 V2Ray 配置文件链接</li>\n<li><code>v2ray infolink</code> 生成 V2Ray 配置信息链接</li>\n<li><code>v2ray qr</code> 生成 V2Ray 配置二维码链接</li>\n<li><code>v2ray ss</code> 修改 Shadowsocks 配置</li>\n<li><code>v2ray ssinfo</code> 查看 Shadowsocks 配置信息</li>\n<li><code>v2ray ssqr</code> 生成 Shadowsocks 配置二维码链接</li>\n<li><code>v2ray status</code> 查看 V2Ray 运行状态</li>\n<li><code>v2ray start</code> 启动 V2Ray</li>\n<li><code>v2ray stop</code> 停止 V2Ray</li>\n<li><code>v2ray restart</code> 重启 V2Ray</li>\n<li><code>v2ray log</code> 查看 V2Ray 运行日志</li>\n<li><code>v2ray update</code> 更新 V2Ray</li>\n<li><code>v2ray update.sh</code> 更新 V2Ray 管理脚本</li>\n<li><code>v2ray uninstall</code> 卸载 V2Ray</li>\n</ul>\n<p>配置完成后，我们将信息设置到支持 V2Ray 的客户端，比如集成了 <a href=\"https://github.com/shadowsocks/v2ray-plugin\" target=\"_blank\">v2ray-plugin</a> 的 <a href=\"https://github.com/shadowsocks/ShadowsocksX-NG\" target=\"_blank\">ShadowsocksX-NG</a>、<a href=\"https://github.com/yanue/V2rayU\" target=\"_blank\">V2rayU</a>、<a href=\"https://github.com/Cenmrev/V2RayX\" target=\"_blank\">V2RayX</a> 等。</p>\n<p>这时候挂上代理访问，我们流量被伪装成网站流量，当别人访问你的域名时，打开的将是你设置的伪装网址，终于你的 IP 就不会直接暴露。</p>\n<p>不过我们 <code>ping</code> 一下域名，就会发现，显示的还是原始 IP。那么下面要做的，就是利用 CDN 中转 V2Ray 的 WebSocket 流量。</p>\n<h2 id=\"cdn-中转\">CDN 中转<a title=\"#cdn-中转\" href=\"#cdn-中转\"></a></h2>\n<p>这里用到的就是 Cloudflare 的<strong>免费</strong>的<strong>自带防御功能</strong>的 CDN 服务。</p>\n<h3 id=\"注册-cloudflare-账号\">注册 Cloudflare 账号<a title=\"#注册-cloudflare-账号\" href=\"#注册-cloudflare-账号\"></a></h3>\n<p>前往<a href=\"https://www.cloudflare.com/\" target=\"_blank\">官网</a>注册一个账号，流程很简单，只需验证一下有效邮箱。</p>\n<h3 id=\"使用-cloudflare-管理域名\">使用 Cloudflare 管理域名<a title=\"#使用-cloudflare-管理域名\" href=\"#使用-cloudflare-管理域名\"></a></h3>\n<p>登录后账户就会引导你添加托管域名。</p>\n<p><img src=\"/2019/hide-ip/add-site.png\" alt=\"添加域名\" class=\"φcx\"></p>\n<p>注意这里必须使用<strong>根域名</strong>，并确保该域名不在于 Cloudflare 官方以及百度云加速以及其他合作商的系统中。</p>\n<h3 id=\"选择-free-套餐\">选择 Free 套餐<a title=\"#选择-free-套餐\" href=\"#选择-free-套餐\"></a></h3>\n<p>添加好网站后，选择套餐，这里点击第一个 Free 方案即可。</p>\n<p><img src=\"/2019/hide-ip/select-a-plan.png\" alt=\"选择套餐\" class=\"φcx\"></p>\n<h3 id=\"补全域名的解析纪录\">补全域名的解析纪录<a title=\"#补全域名的解析纪录\" href=\"#补全域名的解析纪录\"></a></h3>\n<p>Cloudflare 会自动搜索域名的解析记录，如果有我们需要的 DNS 记录但是没有解析出来的，可以手动添加。</p>\n<p>找到伪装域名的解析记录，修改它 DNS 解析记录的代理状态为 Proxied，也就是橘色云朵。</p>\n<p><img src=\"/2019/hide-ip/revise-dns-record.png\" alt=\"修改 DNS 记录\" class=\"φcx\"></p>\n<p>关于 <strong>Proxy state</strong>：</p>\n<ul>\n<li>Proxied：解析 DNS，同时该记录要经过代理</li>\n<li>DNS only：只解析 DNS，不代理</li>\n</ul>\n<p>设置完成后，然后点击 Continue。</p>\n<h3 id=\"替换-dns-服务器\">替换 DNS 服务器<a title=\"#替换-dns-服务器\" href=\"#替换-dns-服务器\"></a></h3>\n<p><img src=\"/2019/hide-ip/replace-nameservers.png\" alt=\"替换 DNS\" class=\"φcx\"></p>\n<p>我们看到 Cloudflare 提示我们将原来的两台 DNS 服务器换成新分配的服务器。前往自己的域名服务商修改 DNS 之后，等待生效，我 10 分钟左右就收到了 “Status Active” 的通知邮件，等待时间正常来说不超过 24h。</p>\n<h2 id=\"效果\">效果<a title=\"#效果\" href=\"#效果\"></a></h2>\n<p>在<a href=\"https://tool.lu/ip/\" target=\"_blank\">IP 地址查询网</a> 上输入域名，看到解析出的 IP 归属地为 CloudFlare 公司 CDN 节点。</p>\n<p><img src=\"/2019/hide-ip/ip-query.png\" alt=\"域名 IP 查询\" class=\"φcx\"></p>\n<p>如此，原始 IP 就被隐藏了。</p>\n<p>同样地，如果 IP 已经被墙，也可以通过这套方案拯救。因为域名托管在 CDN 上，只要 CDN 没有被封，它就可以帮助我们代理访问到 VPS，然后借助 VPS 上的代理科学上网。</p>\n","prev":{"title":"为你的 GitHub 开源项目制作高大上的徽标","link":"2019/make-badge-via-shields-io"},"next":{"title":"还没抢到 HPV？试试这串 JS","link":"2019/oh-hpv"},"plink":"https://blog.fiteen.top/2019/hide-ip/","toc":[{"id":"原理","title":"原理","index":"1"},{"id":"准备工作","title":"准备工作","index":"2"},{"id":"v2ray","title":"V2Ray","index":"3"},{"id":"cdn-中转","title":"CDN 中转","index":"4"},{"id":"效果","title":"效果","index":"5"}],"reward":true,"copyright":{"author":"FiTeen","link":"<a href=\"https://blog.fiteen.top/2019/hide-ip/\" title=\"V2Ray + CDN 中转隐藏 IP\">https://blog.fiteen.top/2019/hide-ip/</a>","license":"Attribution-NonCommercial-NoDerivatives 4.0 International (<a href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/\" rel=\"external nofollow noopener\" target=\"_blank\">CC BY-NC-ND 4.0</a>)"}}